# Serverless Framework Enterprise - AWS Access Role

Serverless Framework Enterprise AWS Access Role helps you secure your service deployments by enabling Serverless Framework Enterprise to issue temporary AWS Access Keys to deploy your services to AWS.

A Serverless Framework service without the Enterprise Plugin uses the AWS Access Keys stored in [environment variables](https://serverless.com/framework/docs/providers/aws/guide/credentials/) or [AWS Profiles](https://serverless.com/framework/docs/providers/aws/guide/credentials/). 

With AWS Access Roles the AWS Access Keys are generated by Serverless Enterprise on every command and the credentials expire after one hour.  Serverless Framework Enterprise leverages AWS Security Token Service and the AssumeRole API to automate creating and usage of temporary credentials, so your developers can stay productive and work securely without doing this manually.

## Minimum Version and Enterprise Plugin Requirements

In order to enable Serverless Secrets for a Service you must update your Service configuration to use Serverless Framework open-source CLI with the Enterprise Plugin version 0.5.0 or later.

## Upgrading

If you are upgrading from a previous version of the enterprise plugin (<=0.5.1) and you were using the secrets feature then you may have the `${secrets:}` variable in your `serverless.yml` to load the AWS credentials in `credentials:`. This is no longer required in 0.6.0 and it will error when you run `sls deploy`. To fix this, remove the line containing `credentials: ${secrets:<key>}` from the `serverless.yml` file.

## Link your AWS Account

1. Open https://dashboard.serverless.com/
2. Once logged in, click "**profiles**" near the top of the page.
3. Navigate to the profile you would like to configure with the AWS Access Role.
4. In the "AWS credential access role" tab, expand the "how to add a role".
5. Follow the directions which will take you through creating an IAM Role for Serverless Framework Enterprise.
6. Click "**save changes**" in the deployment profile to save the IAM Role ARN to the profile.

## Set up the service

To use the generated AWS Access Keys in your service you need to associate the application containing your service with the deployment profile containing the AWS Access Role. You can do this one of two ways.

**Using the AWS Access Role in an application** - Set the `default deployment profile` setting on the application to the profile containing the AWS Access Role. When you run `sls deploy`, the Serverless Framework will use the AWS Access Role in the default deployment profile to generate the AWS Access Keys

**Using the AWS Access Role for in a stage** - In the Application add a new stage (e.g. `prod`) and select the deployment profile containg the AWS Access Role. When you run `sls deploy --stage prod`, the Serverless Framework will use the AWS Access Role from the profile configured on the stage (e.g. `prod`) in that application.

You don't have to do anything in your `serverless.yml` file. When you run `sls deploy` the Enterprise Plugin will identify the deployment profile associated with the application or stage and it will generate the AWS Access Keys using the associated AWS Access Role automatically.

## Test your configuration

Before you run `serverless deploy` ensure that the Serverless Framework open-source CLI is resolving the new AWS Access Keys from Enterprise.

```
serverless print
```

You should expect to see output similar to this one, which includes values for the `accessKeyId`, `secretAccessKey` and `sessionToken` under `credentials` for the `aws` provider.

```yaml
provider:
  name: aws
  credentials:
    accessKeyId: ASOAQ5RKZXALPDISYS34
    secretAccessKey: D3DRPdC9m6vrKOHIPTHw/+8xyl/c62h4gw0xrzlV
    sessionToken: >-
      FQoGZXIvYXdzEHIaDJNjSW4JAsUNWcnpzCKNAqEPjj75DyALiUg5yonFhE9o6rLV3VgH+dg4tZ9WuZBvS1V6Cf8/Tk8cpf7vE3cDrpEDXpNm1Q51bwJnQk7L1S+E5hFK9CFIE/ICyv5HLmxyWqtDHgyyExYljwnovlQz5azmvKJLCjeMF
```

## Deploy using AWS Access Roles

Thatâ€™s it! You are now ready to deploy using the new Serverless Framework Enterprise AWS Access Roles.

```
serverless deploy
```
